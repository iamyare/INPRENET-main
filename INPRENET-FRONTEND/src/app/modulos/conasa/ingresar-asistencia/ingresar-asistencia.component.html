<div class="back-button-container">
  <button mat-raised-button color="primary" class="back-button" routerLink="/home/conasa/menu-conasa">
    <mat-icon>arrow_back</mat-icon> Regresar al Menú
  </button>
</div>

<div class="container">
  <div class="menu-title">
    <h1>{{ menuTitle }}</h1>
  </div>
  <!-- Componente de búsqueda -->
  <app-perfil-header (personaEncontrada)="handlePersonaEncontrada($event)"></app-perfil-header>

  <!-- Formulario principal -->
  <form [formGroup]="asistenciaForm" (ngSubmit)="onSubmit()">
    <!-- Información del contrato -->
    <mat-card *ngIf="persona" class="form-card">
      <div class="card-header">
        <h4 class="card-title">Información del Contrato</h4>
        <p class="card-category">Complete los datos del contrato</p>
      </div>
      <div formGroupName="contratoData" class="card-body">

        <!-- Datos básicos del contrato -->
        <div class="form-row">
          <mat-form-field class="half-width" appearance="outline">
            <mat-label>Fecha de Contrato</mat-label>
            <input matInput type="date" formControlName="fechaContrato" readonly />
            <mat-error *ngIf="contratoData.get('fechaContrato')?.invalid && contratoData.get('fechaContrato')?.touched">
              Este campo es obligatorio.
            </mat-error>
          </mat-form-field>

          <mat-form-field class="half-width" appearance="outline">
            <mat-label>Lugar de Cobro</mat-label>
            <input matInput type="text" formControlName="lugarCobro" />
            <mat-error *ngIf="contratoData.get('lugarCobro')?.invalid && contratoData.get('lugarCobro')?.touched">
              Este campo es obligatorio.
            </mat-error>
          </mat-form-field>
        </div>

        <!-- Datos de la empresa -->
        <div class="form-row">
          <mat-form-field class="half-width" appearance="outline">
            <mat-label>Empresa</mat-label>
            <input matInput type="text" formControlName="empresa" />
            <mat-error *ngIf="contratoData.get('empresa')?.invalid && contratoData.get('empresa')?.touched">
              Este campo es obligatorio.
            </mat-error>
          </mat-form-field>

          <mat-form-field class="full-width" appearance="outline">
            <mat-label>Dirección de Trabajo</mat-label>
            <textarea matInput rows="2" formControlName="direccionTrabajo"></textarea>
            <mat-error *ngIf="contratoData.get('direccionTrabajo')?.invalid && contratoData.get('direccionTrabajo')?.touched">
              Este campo es obligatorio.
            </mat-error>
          </mat-form-field>
        </div>

        <!-- Datos de contacto -->
        <div class="form-row">
          <mat-form-field class="half-width" appearance="outline">
            <mat-label>Teléfono Celular</mat-label>
            <input matInput type="text" formControlName="telCelular" />
            <mat-error *ngIf="contratoData.get('telCelular')?.invalid && contratoData.get('telCelular')?.touched">
              Este campo es obligatorio o no es válido.
            </mat-error>
          </mat-form-field>

          <mat-form-field class="half-width" appearance="outline">
            <mat-label>Teléfono de Casa</mat-label>
            <input matInput type="text" formControlName="telCasa" />
            <mat-error *ngIf="contratoData.get('telCasa')?.invalid && contratoData.get('telCasa')?.touched">
              El número debe ser válido.
            </mat-error>
          </mat-form-field>
        </div>

        <div class="form-row">
          <mat-form-field class="half-width" appearance="outline">
            <mat-label>Teléfono de Trabajo</mat-label>
            <input matInput type="text" formControlName="telTrabajo" />
            <mat-error *ngIf="contratoData.get('telTrabajo')?.invalid && contratoData.get('telTrabajo')?.touched">
              El número debe ser válido.
            </mat-error>
          </mat-form-field>

          <mat-form-field class="half-width" appearance="outline">
            <mat-label>Correo Electrónico</mat-label>
            <input matInput type="email" formControlName="correoElectronico" />
            <mat-error *ngIf="contratoData.get('correoElectronico')?.invalid && contratoData.get('correoElectronico')?.touched">
              Este campo es obligatorio o el correo no es válido.
            </mat-error>
          </mat-form-field>
        </div>

        <!-- Categoría y Plan -->
        <div class="form-row">
          <mat-form-field class="half-width" appearance="outline">
            <mat-label>Categoría</mat-label>
            <mat-select formControlName="categoria" (selectionChange)="onCategoriaChange()">
              <mat-option *ngFor="let categoria of categorias" [value]="categoria.id_categoria">
                {{ categoria.nombre }}
              </mat-option>
            </mat-select>
          </mat-form-field>

          <mat-form-field class="half-width" appearance="outline">
            <mat-label>Plan</mat-label>
            <mat-select formControlName="plan" (selectionChange)="onPlanChange()">
              <mat-option *ngFor="let plan of planesFiltrados" [value]="plan.id_plan">
                {{ plan.nombre_plan }}
              </mat-option>
            </mat-select>
            <mat-error *ngIf="contratoData.get('plan')?.invalid && contratoData.get('plan')?.touched">
              Seleccione un plan.
            </mat-error>
          </mat-form-field>
        </div>

        <div class="form-row">
          <!-- Campo de Monto Calculado -->
          <mat-form-field class="half-width" appearance="outline">
            <mat-label>Monto Calculado</mat-label>
            <input matInput type="text" [value]="'L ' + (montoCalculado !== null ? montoCalculado : '-')" readonly />
          </mat-form-field>

          <mat-form-field class="full-width" appearance="outline">
            <mat-label>Observación</mat-label>
            <textarea matInput rows="2" formControlName="observacion"></textarea>
            <mat-error *ngIf="contratoData.get('observacion')?.invalid && contratoData.get('observacion')?.touched">
              Este campo no puede exceder los 500 caracteres.
            </mat-error>
          </mat-form-field>
        </div>

      </div>
    </mat-card>

    <!-- Componente de Beneficiarios -->
    <app-agregar-beneficiarios
      *ngIf="persona"
      [beneficiariosForm]="beneficiariosForm">
    </app-agregar-beneficiarios>

    <!-- Botón de registro -->
    <div *ngIf="persona" class="actions">
      <button
        mat-raised-button
        color="primary"
        type="submit"
        [disabled]="asistenciaForm.invalid"
      >
        Registrar Asistencia
      </button>
    </div>
  </form>
</div>
